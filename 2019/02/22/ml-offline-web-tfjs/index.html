<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Machine Learning for the Offline Web
 · prose&const</title>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Darshak Parikh">
  <meta name="description" content="" />

  <link rel="stylesheet" href="/main.css" />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <script type="module" src="https://cdn.skypack.dev/@hotwired/turbo"></script>

  
  
    <meta name="keywords" content="">
</head>

<body class="default-style">
  <section class="container">
    <style>
.main-header {
  align-items: flex-end;
  gap: 1.25rem;
  justify-content: space-between;
  min-width: 100%;
  padding-bottom: 0.1rem;
  white-space: nowrap;
}

.main-header small {
  color: var(--primary-color-dimmed);
  font-size: 1em;
  line-height: 1.2;
  margin-inline-end: auto;
}

@media (max-width: 719px) {
  .main-header {
    align-items: flex-start;
    flex-direction: column;
    gap: 0.8rem;
  }
}

.header-nav ul {
  gap: 1.5rem;
}

@media (max-width: 719px) {
  .header-nav ul {
    gap: 0.75rem;
  }
}

.header-nav a {
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-size: 0.85em;
  font-weight: bold;
  color: var(--primary-color-dimmed);
}
</style>

<header class="main-header is-flex is-flex-wrap">
  <style>
/* Fonts */

@font-face {
  font-family: "Playfair Display";
  font-style: normal;
  font-weight: 400;
  src: url("data:font/woff;base64,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")
    format("woff");
}

@font-face {
  font-family: "Lacquer";
  font-style: normal;
  font-weight: 400;
  src: url("data:font/woff2;base64,d09GMgABAAAAAAToAA4AAAAACXgAAASUAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGh4bXhweBmAAPBEICokwhl4LCAABNgIkAwwEIAWDaAcgGykHyMSH2NR/dxCpQ0uO1qkKycxq7lNNtn1Dvoh75v9waWNi2PNPEmBGf7X+aK1Fw8qwLFuUzju7M9h4wHSKutEJZnKRtUFAocrACvd3XETBuOSLaGSAFBRVNMAOfpRdWIyMD85Nwc5mCXhQ2EFIgkKyknEI367g/Qsko5QeQTe2HolI7HbzlJFTYUGOummLIsqTbUgXnCQDdI1UHqqqrirEg1CQxH3pXQPwu2nmsJn8Su+NKeCAj8eJSyKcwMQjRWnFl0soSLoGIRXvR953j4BoEK8XQQXnTGGVjeQ0edYEzlvkgOt43hua52wMsPlvswVYJw2DGVcznaUVdWZImmbm3JLmyw2a5GMGR2rw0oR2CLZ3zBW+bsNXY2wfM3zdBjMMxqI3MQyyjxHTlM+5IOKcGyLMc2TZZOz6aONsQvadI5vnyOdcIx2+Rr5ntXmFn36ZQ9cdbO4sh+44C3tD1xZX7ompMiV0qQTmGHPpqtRUXXd4iMeUzStkc5OgKfsKM+eRzcvA9HH0nFgTvo9IatKaVY5fKkmaQ3dk7tOhX7U79skMfHTg0qEN8VoL/hmyjzFDNpnh/p4WM3w197Vmr4zUzgT26lC5Iwi0eBaw5EVkLpL52T5jICf4Dz1T2qtBO1PCXofup6tPnPrlqVz87QczDsLa2P/G4Fk9V3zzrBm8rXjFiEskqghVEFwKiRM5CqWeK47Pi1WdJPfRgzuXlRply025OZQTtyRQCxFozSrwuZqN5gpinnL7191JlYxPs1ipzepvXXnXGWcMfjjy03BwCOlw7QhP9JMC1qSnL5f3RN97dsMTKZftE30urL149vcBnxeOfbahMi1WiHonsX3lOPM0XrvQWJ8X2xAHV/BI4HLDNQ0QSP5KsfXh1tQ2CYAFVMXllYaKK3vOrHd9N5DcWtKUcCiXCqflnNYbX2i4SlemSaUJu27O6bNYbdS3OP5QrlJ/nuCCIM77LeS54ujKCwHimXniwD9L+eaKgVUJUnL33qL7FsJcvwquqxvPPjr8w1LBPYWF5xYWtCdW+NvrC+K4kEZQITd4xayYC9oTULvPvlB/ZeHUfln1sVt8rZydT7dWsOCQks22m3tmP58/R61XnfGFO+qVELH5wWH3bzukwrg4URAbPEXjb1QQkInRqAB7osOiAABAAJCws9/+OiS0O2jDb3aO+xIA3vxhNg8A3toS/YJ3zX+vcM/yuwFYQQEABPTP78H94l3z3wL3rGBAOM2RX+EkpwL0dKQogxwfADu/A0sup9W4HUPCwcf7KKkr8XYBCALxrJJq7wccVsANeERjAlgQjjpgRTRWuALl1wAjWMACZrAO2cjGPPoxh1HMYAGmLMy/1wSyMI05DCMb1ShCBSrQi37MYhGDmEMm6jCIYSU2gV6FN3XgRb81jSkoUJEFFTnIkS0pC1M+ynpUoRpVKMT6Y1ZUVkwbzMc0ZrDtKXz4iX9ZgRM5ULEWChowgkEo1zlVgzlMYwyD6J88mItFLGDk8Z15KEj5LDmvJIYxOhhbRJ+5fT+mMYnsK/Oij9i80ClTRfhO8J4LJ1wAAAA=")
    format("woff2");
}

@font-face {
  font-family: "Inconsolata";
  font-stretch: 100%;
  font-style: normal;
  font-weight: 420;
  src: url("data:font/woff2;base64,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")
    format("woff2");
}

/* Styles */

.logo {
  color: var(--primary-color-dimmed);
  line-height: 0.9;
  text-decoration: none;
  word-spacing: -0.5ch;
}

.logo-prose {
  font-family: "Playfair Display", serif;
  font-size: 1.8rem;
  letter-spacing: -0.02rem;
}

.logo-and {
  color: var(--accent-color);
  font-family: "Lacquer", cursive;
  font-size: 2rem;
}

.logo-const {
  font-family: "Inconsolata", monospace;
  font-size: 2rem;
  font-weight: 420;
  letter-spacing: -0.13rem;
}
</style>

<a href="/" class="logo">
  <span class="logo-prose">prose</span>
  <span class="logo-and">&</span>
  <span class="logo-const">const</span>
</a>
  <small>Code and musings by Darshak Parikh</small>
  
  <nav class="header-nav">
    <ul class="is-flex">
      
        <li>
          <a href="&#x2F;blog">blog</a>
        </li>
      
        <li>
          <a href="&#x2F;digital-garden">digital garden</a>
        </li>
      
        <li>
          <a href="&#x2F;projects">projects</a>
        </li>
      
        <li>
          <a href="&#x2F;about">about</a>
        </li>
      
    </ul>
  </nav>
</header>
    
<main class="page-wrapper is-centered-y is-flex-column">
  <article class="page is-flex-column">
    <header>
      <h1>Machine Learning for the Offline Web</h1>
      <div class="byline-container">
        <span class="byline date">
          
            Posted
            <time class="value" datetime="2019-02-22" pubdate>22 Feb 2019</time>
          
          
        </span>
        
      </div>
    </header>
    <section class="page-body">
      <p>Offline Web apps are finally a thing. The cleverest of ideas which were previously only imagination, are now reality.</p>
<p>Thanks to the various storage mechanisms provided by modern browsers, it is now possible to save machine learning models directly on the client side. You can then use these to produce outputs without requiring a connection with the server.</p>
<p>This post demonstrates how to do that.</p>
<span id="continue-reading"></span><h2 id="introduction">Introduction</h2>
<p><a target="_blank" rel="noopener" href="https://js.tensorflow.org/">TensorFlow.js</a> is an open source machine learning library backed by Google. It lets you develop and train neural networks in a style similar to its Python counterparts, <a target="_blank" rel="noopener" href="https://keras.io">Keras</a> and <a target="_blank" rel="noopener" href="https://www.tensorflow.org">TensorFlow</a> (the Python one).</p>
<p>In this post, we will use the ability of TensorFlow.js to save a model into browser storage and use it to make predictions offline.</p>
<p>We won’t be developing a model from scratch, since that is out of the scope of this post. You can always look up the excellent <a target="_blank" rel="noopener" href="https://js.tensorflow.org/tutorials/">tutorials</a> on the TensorFlow.js site for that.</p>
<p>For our small project, we will pick an already developed model for the classic deep learning problem of recognizing handwritten digits.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>To be able to follow this guide, you will need some rudimentary knowledge of:</p>
<ul>
<li>Node.js</li>
<li>General concepts surrounding neural networks, like training and one-hot encoding</li>
</ul>
<p>Further, you will need the following software installed on your machine:</p>
<ul>
<li>Node.js (v8.15.0 or later)</li>
<li>Git (optional)</li>
<li>Any modern browser</li>
</ul>
<p>Ready? Let’s get started.</p>
<h2 id="step-1-train-a-model">Step 1: Train a Model</h2>
<p>A good <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tfjs-examples/tree/master/mnist-node">implementation</a> of the digit recognition neural network is provided by the Tensorflow.js community. It uses the famous MNIST data set for training. We are going to get the source code and train this model ourselves. If you prefer not to do so, you can skip to Step 1a.</p>
<p>Go to the <a target="_blank" rel="noopener" href="https://github.com/tensorflow/tfjs-examples">tensorflow/tfjs-examples</a> repository on GitHub and clone or download it to your machine.</p>
<p>Navigate into the <code>tfjs-examples/mnist-node</code> directory. Install the dependencies using this command:</p>
<pre data-lang="sh" style="background-color:#0f1419;color:#bfbab0;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb454;">npm</span><span> install
</span></code></pre>
<p>Next, run the following command to train the model and save its files:</p>
<pre data-lang="sh" style="background-color:#0f1419;color:#bfbab0;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb454;">node</span><span> main.js</span><span style="color:#f29718;"> --model_save_path</span><span style="color:#f29668;">=</span><span>./models
</span></code></pre>
<p>These will take a few (or several) minutes to run, depending on your hardware. Once it is finished, you will see a new <code>models</code> directory under <code>mnist-node</code>. It will have two files:</p>
<ul>
<li><code>model.json</code> is the compiled structure of the neural network. It contains information about the size, shape and configuration of each layer, among other things.</li>
<li><code>weights.bin</code>, as the name suggests, contains the weights assigned to each node after training the network.</li>
</ul>
<h3 id="step-1a-download-pre-trained-model-optional">Step 1a: Download Pre-trained Model (Optional)</h3>
<p>If you don’t want to train the model yourself, you can download the pre-trained files from my repository:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dar5hak/offline-mnist/master/static/models/model.json">model.json</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dar5hak/offline-mnist/blob/master/static/models/weights.bin?raw=true">weights.bin</a></li>
</ul>
<h2 id="step-2-web-application-setup">Step 2: Web Application Setup</h2>
<p>Create a separate directory somewhere else for your Web app source code. Let’s call it <code>offline-mnist</code>.</p>
<p>To tell the universe that we’ll be using npm dependencies, run this command inside your <code>offline-mnist</code> directory:</p>
<pre data-lang="sh" style="background-color:#0f1419;color:#bfbab0;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb454;">npm</span><span> init</span><span style="color:#f29718;"> -y
</span></code></pre>
<p>This will generate a <code>package.json</code> file.</p>
<p>Since we want to use TensorFlow.js in our code, let’s declare it as a dependency:</p>
<pre data-lang="sh" style="background-color:#0f1419;color:#bfbab0;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb454;">npm</span><span> install @tensorflow/tfjs
</span></code></pre>
<p>This is also where you might want to install any development dependencies you require for the project. I used TypeScript with Parcel bundler, so I had to do something like:</p>
<pre data-lang="sh" style="background-color:#0f1419;color:#bfbab0;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#ffb454;">npm</span><span> install</span><span style="color:#f29718;"> --save-dev</span><span> typescript parcel-bundler parcel-plugin-static-files-copy
</span></code></pre>
<h2 id="step-3-copy-the-model">Step 3: Copy the Model</h2>
<p>Copy the <code>models</code> directory you created in Step 1, and paste it into your project directory, inside a new <code>static</code> subdirectory (or wherever your bundler looks for static assets).</p>
<p>This will ensure that your trained model files are available for the browser to download.</p>
<h2 id="step-4-load-the-model-using-http">Step 4: Load the Model using HTTP</h2>
<p>Awesome! Now that the boilerplate is done, it is time to put some sizzling code onto it.</p>
<p>Create an <code>index.js</code> file (or <code>index.ts</code> if you chose TypeScript).</p>
<p>First things first:</p>
<pre data-lang="js" style="background-color:#0f1419;color:#bfbab0;" class="language-js "><code class="language-js" data-lang="js"><span style="color:#ff7733;">import </span><span>{ loadLayersModel } </span><span style="color:#ff7733;">from </span><span style="color:#c2d94c;">&quot;@tensorflow/tfjs&quot;</span><span style="color:#bfbab0cc;">;
</span></code></pre>
<p>The <code>loadLayersModel</code> function lets you fetch your TensorFlow.js model from a variety of sources—HTTP in our case. It returns a <code>Promise</code> of the model object.</p>
<p>We need to provide a URL to <code>loadLayersModel</code> to tell it where to get the files from. If it starts with <code>http://</code> or <code>https://</code>, it will know that it needs to make an HTTP call.</p>
<p>Since we are serving everything from the same origin, we will use <code>window.location.href</code> to determine the current origin, which might be something like <code>http://127.0.0.1:1234/</code>.</p>
<pre data-lang="js" style="background-color:#0f1419;color:#bfbab0;" class="language-js "><code class="language-js" data-lang="js"><span style="color:#ff7733;">const </span><span>MODEL_HTTP_URL </span><span style="color:#f29668;">= </span><span style="color:#c2d94c;">&quot;models/model.json&quot;</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span style="color:#ff7733;">async function </span><span style="color:#ffb454;">fetchModel</span><span>() {
</span><span>  </span><span style="color:#ff7733;">try </span><span>{
</span><span>    </span><span style="color:#ff7733;">const </span><span>model </span><span style="color:#f29668;">= </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">loadLayersModel</span><span>(window</span><span style="color:#f29668;">.</span><span>location</span><span style="color:#f29668;">.</span><span>href </span><span style="color:#f29668;">+ </span><span>MODEL_HTTP_URL)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(</span><span style="color:#c2d94c;">&quot;Model loaded from HTTP.&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(model)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="color:#ff7733;">return </span><span>model</span><span style="color:#bfbab0cc;">;
</span><span>  } </span><span style="color:#ff7733;">catch </span><span>(error) {
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">error</span><span>(error)</span><span style="color:#bfbab0cc;">;
</span><span>  }
</span><span>}
</span></code></pre>
<p>The <code>model</code> object is now available for use.</p>
<h2 id="step-5-save-the-model-to-indexeddb">Step 5: Save the Model to IndexedDB</h2>
<p>Now that you have the model object available, the first thing to do is to save it to browser storage. The storage mechanism we will use is called IndexedDB.</p>
<pre data-lang="js" style="background-color:#0f1419;color:#bfbab0;" class="language-js "><code class="language-js" data-lang="js"><span style="color:#ff7733;">const </span><span>MODEL_HTTP_URL </span><span style="color:#f29668;">= </span><span style="color:#c2d94c;">&quot;models/model.json&quot;</span><span style="color:#bfbab0cc;">;
</span><span style="color:#ff7733;">const </span><span>MODEL_INDEXEDDB_URL </span><span style="color:#f29668;">= </span><span style="color:#c2d94c;">&quot;indexeddb://mnist-model&quot;</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span style="color:#ff7733;">async function </span><span style="color:#ffb454;">fetchModel</span><span>() {
</span><span>  </span><span style="color:#ff7733;">try </span><span>{
</span><span>    </span><span style="color:#ff7733;">const </span><span>model </span><span style="color:#f29668;">= </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">loadLayersModel</span><span>(window</span><span style="color:#f29668;">.</span><span>location</span><span style="color:#f29668;">.</span><span>href </span><span style="color:#f29668;">+ </span><span>MODEL_HTTP_URL)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(</span><span style="color:#c2d94c;">&quot;Model loaded from HTTP.&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// Store the downloaded model locally for future use
</span><span>    </span><span style="color:#ff7733;">await </span><span>model</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">save</span><span>(MODEL_INDEXEDDB_URL)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(</span><span style="color:#c2d94c;">&quot;Model saved to IndexedDB.&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>    </span><span style="color:#ff7733;">return </span><span>model</span><span style="color:#bfbab0cc;">;
</span><span>  } </span><span style="color:#ff7733;">catch </span><span>(error) {
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">error</span><span>(error)</span><span style="color:#bfbab0cc;">;
</span><span>  }
</span><span>}
</span></code></pre>
<p>If you look at the URL we used to save it, you will see that it starts with <code>indexeddb://</code>. This tells TensorFlow.js where to store it.</p>
<h2 id="step-6-put-it-together">Step 6: Put It Together</h2>
<p>All right, so we now have a fast, offline way to get our model. So, for any subsequent page loads, we should always load from IndexedDB, right?</p>
<p>Not exactly.</p>
<p>Of course, we want speed, so we should prefer IndexedDB, but bear in mind that it is not 100% reliable.</p>
<p>Your saved data might no longer be available in any of these scenarios:</p>
<ul>
<li>The user is browsing in private/incognito mode</li>
<li>The user clears site data, or their entire browser data</li>
<li>The browser decides to make space when the device is running out of storage</li>
</ul>
<p>In times like this, old HTTP can still come to our rescue.</p>
<p>We try to fetch the model from IndexedDB first, because it is quicker, but if that fails, we fetch it from HTTP and save it again to IndexedDB.</p>
<pre data-lang="js" style="background-color:#0f1419;color:#bfbab0;" class="language-js "><code class="language-js" data-lang="js"><span style="color:#ff7733;">async function </span><span style="color:#ffb454;">fetchModel</span><span>() {
</span><span>  </span><span style="color:#ff7733;">try </span><span>{
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// Try loading locally saved model
</span><span>    </span><span style="color:#ff7733;">const </span><span>model </span><span style="color:#f29668;">= </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">loadLayersModel</span><span>(MODEL_INDEXEDDB_URL)</span><span style="color:#bfbab0cc;">;
</span><span>    </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(</span><span style="color:#c2d94c;">&quot;Model loaded from IndexedDB&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>    </span><span style="color:#ff7733;">return </span><span>model</span><span style="color:#bfbab0cc;">;
</span><span>  } </span><span style="color:#ff7733;">catch </span><span>(error) {
</span><span>    </span><span style="font-style:italic;color:#5c6773;">// If local load fails, get it from the server
</span><span>    </span><span style="color:#ff7733;">try </span><span>{
</span><span>      </span><span style="color:#ff7733;">const </span><span>model </span><span style="color:#f29668;">= </span><span style="color:#ff7733;">await </span><span style="color:#ffb454;">loadLayersModel</span><span>(
</span><span>        window</span><span style="color:#f29668;">.</span><span>location</span><span style="color:#f29668;">.</span><span>href </span><span style="color:#f29668;">+ </span><span>MODEL_HTTP_URL
</span><span>      )</span><span style="color:#bfbab0cc;">;
</span><span>      </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(</span><span style="color:#c2d94c;">&quot;Model loaded from HTTP.&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>      </span><span style="font-style:italic;color:#5c6773;">// Store the downloaded model locally for future use
</span><span>      </span><span style="color:#ff7733;">await </span><span>model</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">save</span><span>(MODEL_INDEXEDDB_URL)</span><span style="color:#bfbab0cc;">;
</span><span>      </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">log</span><span>(</span><span style="color:#c2d94c;">&quot;Model saved to IndexedDB.&quot;</span><span>)</span><span style="color:#bfbab0cc;">;
</span><span>
</span><span>      </span><span style="color:#ff7733;">return </span><span>model</span><span style="color:#bfbab0cc;">;
</span><span>    } </span><span style="color:#ff7733;">catch </span><span>(error) {
</span><span>      </span><span style="font-style:italic;color:#39bae6;">console</span><span style="color:#f29668;">.</span><span style="color:#f07178;">error</span><span>(error)</span><span style="color:#bfbab0cc;">;
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre>
<p>There! Nice and robust!</p>
<h2 id="step-7-make-predictions">Step 7: Make Predictions</h2>
<p>Now that our function is ready, time has come to put it to some good use.</p>
<p>What we need here is the <code>predict</code> method on our model. It takes a <a target="_blank" rel="noopener" href="https://js.tensorflow.org/tutorials/core-concepts.html">tensor</a> data type as an input.</p>
<p>Tensors are, in really simplified terms, n-dimensional arrays of fixed size and fixed data type.</p>
<p>Our digit recognition model is designed to accept a four-dimensional tensor as input. The shape of the tensor needs to be <code>[1, 28, 28, 1]</code>. This means that the first dimension will have length <code>1</code>, the second will have length <code>28</code>, and so on.</p>
<p>The output is also a tensor of which the second dimension is a one-hot encoded array of predictions. We can determine the result using <code>argMax</code> on this dimension.</p>
<p>Translating all this information into code will result in:</p>
<pre data-lang="js" style="background-color:#0f1419;color:#bfbab0;" class="language-js "><code class="language-js" data-lang="js"><span style="color:#ff7733;">async function </span><span style="color:#ffb454;">predict</span><span>(</span><span style="color:#f29718;">input</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">model</span><span>) {
</span><span>  </span><span style="color:#ff7733;">const </span><span>prediction </span><span style="color:#f29668;">= </span><span>model</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">predict</span><span>(input</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">reshape</span><span>([</span><span style="color:#f29718;">1</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">28</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">28</span><span style="color:#bfbab0cc;">, </span><span style="color:#f29718;">1</span><span>]))</span><span style="color:#bfbab0cc;">;
</span><span>  </span><span style="color:#ff7733;">const </span><span>result </span><span style="color:#f29668;">= </span><span style="color:#ff7733;">await </span><span>prediction</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">argMax</span><span>(</span><span style="color:#f29718;">1</span><span>)</span><span style="color:#f29668;">.</span><span style="color:#ffb454;">data</span><span>()</span><span style="color:#bfbab0cc;">;
</span><span>  </span><span style="color:#ff7733;">return </span><span>result[</span><span style="color:#f29718;">0</span><span>]</span><span style="color:#bfbab0cc;">;
</span><span>}
</span></code></pre>
<p>The input in this case is the user-drawn digit on a Web page, transformed into a tensor type. How to do that is, again, a long story, but you can always refer to <a target="_blank" rel="noopener" href="https://github.com/dar5hak/offline-mnist">my repository</a> for that.</p>
<p>For a live demo, check out <a target="_blank" rel="noopener" href="https://dar5hak.github.io/offline-mnist/">my implementation</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>We wanted to make neural network predictions offline. To do so, we trained a model and fetched it from HTTP into our Web application. We then stored it to IndexedDB for later use.</p>
<p>In every subsequent call, we tried to load the model from IndexedDB, thus saving a network call, failing which we fell back to fetching it again from HTTP.</p>
<p>This is the simplest use case for making predictions, and I hope you can now get started with more advanced applications of offline-first machine learning.</p>
<p>Keep learning, and keep your machines learning.</p>
<h3 id="update-2019-08-04">Update 2019-08-04</h3>
<p>Changed the code to work with TensorFlow.js 1.x.</p>

    </section>
    
      <footer class="page-footer">
        <address class="is-centered-y">
          <div class="headshot-small"><img alt="Darshak Parikh's photo" src="/images/photo.webp"/> </div>
          <div>
            <p>Hello, I’m Darshak Parikh. I write apps
              <a href="https://github.com/elfenware" target="_blank">for elementary OS</a>
              and
              <a href="https://github.com/dar5hak" target="_blank">the web</a>.
                                And I read
              <a href="digital-garden/books/">books</a>
              and
              <a href="digital-garden/manga-and-friends/">stuff</a>.
            </p>
            <p>
              Know more <a href="/about">about me</a>, subscribe to my <a href="/atom.xml" target="_blank">feed</a>, or reach out to me on
              <a href="https://im-in.space/@dubiousdisc" rel="noopener" target="_blank">Mastodon</a>.
            </p>
          </div>
        </address>
      </footer>
    
  </article>
</main>
     
  </section>
</body>

</html>
